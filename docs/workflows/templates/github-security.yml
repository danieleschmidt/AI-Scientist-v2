# ðŸ” GitHub Actions Security Template for AI Scientist v2
#
# This template provides comprehensive security scanning and compliance automation
# To implement: Copy this file to .github/workflows/security.yml in your repository
#
# Required repository secrets:
# - SEMGREP_APP_TOKEN (optional, for enhanced Semgrep scanning)
# - GITLEAKS_LICENSE (optional, for GitLeaks Pro features)

name: ðŸ” Security & Compliance

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ” COMPREHENSIVE SECURITY SCANNING
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  codeql-analysis:
    name: ðŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python', 'javascript' ]
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ” DEPENDENCY VULNERABILITY SCANNING
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  dependency-review:
    name: ðŸ” Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC
          deny-licenses: GPL-2.0, GPL-3.0, LGPL-2.1, LGPL-3.0

  safety-scan:
    name: ðŸ›¡ï¸ Safety Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Safety
        run: |
          pip install safety

      - name: ðŸ›¡ï¸ Run Safety Check
        run: |
          safety check --json --output safety-report.json
          safety check  # Also run with text output for logs

      - name: ðŸ“¤ Upload Safety Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-vulnerability-report
          path: safety-report.json

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ” STATIC APPLICATION SECURITY TESTING (SAST)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  bandit-scan:
    name: ðŸ” Bandit SAST Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Bandit
        run: |
          pip install bandit[toml]

      - name: ðŸ” Run Bandit Security Scan
        run: |
          bandit -r ai_scientist/ -f json -o bandit-report.json
          bandit -r ai_scientist/ -f txt  # Also output to console

      - name: ðŸ“¤ Upload Bandit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  semgrep-scan:
    name: ðŸ” Semgrep SAST Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/python
            p/owasp-top-ten
            p/docker
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ³ CONTAINER SECURITY SCANNING
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  trivy-scan:
    name: ðŸ³ Trivy Container Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Build Docker Image
        run: |
          docker build -t ai-scientist:security-test .

      - name: ðŸ” Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ai-scientist:security-test
          format: 'sarif'
          output: 'trivy-container-results.sarif'

      - name: ðŸ“Š Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-container-results.sarif'

      - name: ðŸ” Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'

      - name: ðŸ“Š Upload Filesystem Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ” SECRET SCANNING
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  trufflesecurity-scan:
    name: ðŸ” TruffleHog Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  gitleaks-scan:
    name: ðŸ” GitLeaks Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ“Š COMPLIANCE AND POLICY CHECKS
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  compliance-check:
    name: ðŸ“Š Compliance Assessment
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install -e ".[security]"

      - name: ðŸ“Š Run Compliance Checks
        run: |
          echo "ðŸ” Running SOC2 compliance checks..."
          python security/compliance_checker.py --framework soc2 || echo "Compliance checker not available"
          
          echo "ðŸ” Running GDPR compliance checks..."
          python security/compliance_checker.py --framework gdpr || echo "Compliance checker not available"
          
          echo "ðŸ” Running NIST compliance checks..."
          python security/compliance_checker.py --framework nist || echo "Compliance checker not available"

      - name: ðŸ“¤ Upload Compliance Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-report
          path: compliance-report.json

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ“„ GENERATE SECURITY REPORT
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  security-report:
    name: ðŸ“„ Security Report
    runs-on: ubuntu-latest
    needs: [
      codeql-analysis,
      safety-scan,
      bandit-scan,
      semgrep-scan,
      trivy-scan,
      trufflesecurity-scan,
      gitleaks-scan,
      compliance-check
    ]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: ðŸ“„ Generate Security Summary
        run: |
          echo "# ðŸ” Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Scan Date:** $(date)" >> security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## ðŸ” Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Scanner | Status |" >> security-summary.md
          echo "|---------|--------|" >> security-summary.md
          echo "| CodeQL | ${{ needs.codeql-analysis.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md
          echo "| Safety | ${{ needs.safety-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md
          echo "| Bandit | ${{ needs.bandit-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md
          echo "| Semgrep | ${{ needs.semgrep-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md
          echo "| Trivy | ${{ needs.trivy-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md
          echo "| TruffleHog | ${{ needs.trufflesecurity-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md
          echo "| GitLeaks | ${{ needs.gitleaks-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md
          echo "| Compliance | ${{ needs.compliance-check.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> security-summary.md

      - name: ðŸ“¤ Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-report
          path: security-summary.md